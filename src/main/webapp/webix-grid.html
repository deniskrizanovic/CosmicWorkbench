<!DOCTYPE html>
<html lang="en">
<head>
    <title>Funky Funky Grid</title>
    <link rel="stylesheet" href="resources/js/codebase/skins/terrace.css" type="text/css" charset="utf-8">
    <script src="resources/js/codebase/webix.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="resources/css/webix-samples.css">
</head>


<body>


<div id="webixUItable" style='width:1500px; height:600px; margin:20px'></div>
<div id="webixUIForm"></div>
<input type='button' class="sample_button" value='add datagroup' onclick='addDataGroup()'>
<input type='button' class="sample_button" value='add step' onclick='addStep()'>
<input type='button' class="sample_button" value='show me the grid' onclick='show_grid()'>

<!--<div id="mutliselect" class='sample_comment'></div>-->
<!--<div id="gridnow" class='sample_comment'></div>-->
<!--<div id="hidden text" class='sample_comment, hide'>blablahbla</div>-->


<script>

    var gridConfig = {
        view: "datatable",
        id: "fpGrid",
        columns: [
            {id: "fp", editor: "text", header: "steps"},
            {
                id: "dg1",
                header: "Data Group 1",
                css: "centre",
                autoWidth: true,
                width: 150
            },
            {
                id: "dg2",
                header: "Data Group 2",
                css: "centre",
                autoWidth: true,
                width: 150
            },
            {
                id: "dg3",
                header: "Data Group 3",
                css: "centre",
                autoWidth: true,
                width: 150
            }
        ],

        autoheight: true,
        autowidth: true,
        select: "cell",
        multiselect: true,
        dragColumn: true,
        drag: true,
        tooltip: function (row, columnContainer) {
            var rowValue = row[columnContainer.column.id];
            if (rowValue != "-") {
                return "<i>" + " display attributes here for cell:: " + row.id + ":" + columnContainer.column.id + "</i>";
            }
            else {
                return "<i>" + rowValue + "</i>";
            }
        },

        on: {
            onItemDblClick: function (id, e) {

                var gridCoOrds = this.getSelectedId(true, true);
                var rowNum = gridCoOrds[0].slice(0, gridCoOrds[0].indexOf("_"));
                var colName = gridCoOrds[0].slice(gridCoOrds[0].indexOf("_") + 1, gridCoOrds[0].length);

                var item = this.getItem(id);
                webix.message(item[colName]);

                //we need to send id to form to know what item to edit
                var formData = {type: item[colName], id: item.id, dg: colName};
                var form = $$("editDM");
                form.setValues(formData);
                if (form.isVisible()) {
                    form.hide();
                }
                else {
                    readAttributesFromAServer();
                    form.show();
                }
            }
        }
    };


    var fpList = {
        view: "list",
        width: 320,
        height: 600,
        select: true,
        template: "#name#",
        on: {
            onAfterSelect: function (listIndex, e) {

                var fpName = this.getItem(listIndex).name;
                refreshDataTableWithNewFunctionalProcess(fpName);

            }
        }
    };


    var contextMenu = {
        view: "contextmenu",
        id: "ctxMenu",
        data: [{id: "newScenario", value: "New Sizing Scenario"}, {
            id: "DGUsage",
            value: "Where else this dataGroup is used?"
        }],
        width: 300,
        click: function (id, context) {
            var dt = $$("fpGrid");
            webix.message(id + " on row " + this.getContext().id);
            var text = dt.getSelectedId(true, true);
            webix.message(JSON.stringify(text));
        }
    };


    var editDataMovementForm = {
        container: "webixUIForm",
        view: "form",
        id: "editDM",
        hidden: "true",
        width: 300,
        elements: [
            {view: "select", name: "type", label: "Type", options: ["E", "X", "R", "W"]},
            {view: "text", name: "dg", label: "dg", hidden: "true"},
            {
                view: "button", id: "SubmitButton", inputWidth: 200, value: "Save", click: function () {
                saveDataToGrid()
            }
            }]

    };


    var selectDataGroupForm = {
        container: "webixUIForm",
        view: "form",
        id: "selectDG",
        hidden: "true",
        width: 300,
        elements: [
            {
                view: "select",
                name: "NewDataGroup",
                label: "Choose a Data Group",
                options: ["get my DG's from the db", "DataGroup4", "DataGroup5", "DataGroup6"]
            },
            {view: "text", name: "dg", label: "dg", hidden: "true"},
            {
                view: "button", id: "SubmitButton2", inputWidth: 200, value: "Save", click: function () {
                saveDataGroupToGrid();
            }
            }]

    };


</script>
<script>

    function saveDataGroupToGrid() {

        var form = $$("selectDG");
        var dt = $$("fpGrid");

        var values = form.getValues();

        var columns = webix.toArray(dt.config.columns);

        columns.insertAt({
            id: values.NewDataGroup.replace(" ", ""),
            header: values.NewDataGroup,
            css: "centre",
            width: 200
        }, columns.length);

        form.hide();

        //add the empty record.
        var data = webix.toArray(dt.config.data);
        for (var j = 0; j < data.length; j++) {
            var dataRecord = data[j];
            dataRecord[values.NewDataGroup] = "-";
        }

        dt.refreshColumns();

    }


    function addDataGroup() {

        var form = $$("selectDG");
        form.show();
    }

    function addStep() {
        var dt = $$("fpGrid");

        var rows = dt.count();
        dt.add({
            fp: "step3",
            dg1: "-",
            dg2: "-",
            dg3: "-"
        });

    }

    function show_grid() {

        var dt = $$("fpGrid");
        document.getElementById('gridnow').innerHTML = JSON.stringify(dt.data.serialize());
    }

    function saveDataToGrid() {

        var values = $$("editDM").getValues();
        webix.message(JSON.stringify(values));


        if (values.id) {
            var item = $$("fpGrid").getItem(values.id);

            var column = $$("editDM").getValues()["dg"];

            item[column] = values.type;
            $$("fpGrid").updateItem(item.id, item);
            //do something to save attr1 and attr2
        }

        $$("editDM").hide();
    }

    function readAttributesFromAServer() {

        var raw = webix.ajax().sync().get("/CosmicWorkBench/dg3.json");
        var dg3 = JSON.parse(raw.response);
        var attribs = dg3["attributes"];

        var form2 = $$("editDM");

        var pos = form2.index($$("SubmitButton"));

        //there should be some check to see if we've already read the datagroups.. because this just stupidly repeats the read
        for (i = 0; i < attribs.length; i++) {

            var attrib = attribs[i];

            form2.addView({
                id: "myID" + attrib,
                view: "checkbox",
                name: attrib,
                label: attrib
            }, pos);
        }


        form2.refresh();

    }

    function getListOfFunctionalProcesses() {

        return [
            {id: 1, name: "1FuncProce10"},
            {id: 2, name: "2FuncProce20"},
            {id: 3, name: "3FuncProce30"},
            {id: 4, name: "4FuncProce40"},
            {id: 5, name: "5FuncProce50"}
        ];

    }

    function getFunctionalProcessData() {

        return [
            {id: 1, fp: "step1", dg1: "-", dg2: "E", dg3: "-"},
            {id: 2, fp: "step2", dg1: "E", dg2: "-", dg3: "-"}
        ];
    }



    function refreshDataTableWithNewFunctionalProcess(fpName) {

        var newFPData = getFunctionalProcessData();
        newFPData.push({id: 3, fp: "step" + fpName, dg1: "-", dg2: "-", dg3: "W"})

        var dt = $$("fpGrid");
        dt.clearAll();

        for(var i in newFPData) {
            dt.add(newFPData[i]);
        }


    }


</script>

<script>

    fpList.data = getListOfFunctionalProcesses();
    gridConfig.data = getFunctionalProcessData();

    webix.ui({
        container: "webixUItable",
        id:"theWholeThing",
        type: "wide",
        autoWidth: true,
        cols: [fpList, {view: "resizer"}, gridConfig]
    });

    webix.ui(editDataMovementForm);
    webix.ui(selectDataGroupForm);
    webix.ui(contextMenu);
    $$("ctxMenu").attachTo($$("fpGrid"));



</script>


</body>
</html>